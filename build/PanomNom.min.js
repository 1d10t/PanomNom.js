'use strict';(function(){var g=function(){};g.prototype={constructor:g,apply:function(c){c.addEventListener=g.prototype.addEventListener;c.hasEventListener=g.prototype.hasEventListener;c.removeEventListener=g.prototype.removeEventListener;c.dispatchEvent=g.prototype.dispatchEvent},addEventListener:function(c,d){void 0===this._listeners&&(this._listeners={});var b=this._listeners;void 0===b[c]&&(b[c]=[]);-1===b[c].indexOf(d)&&b[c].push(d)},hasEventListener:function(c,d){if(void 0===this._listeners)return!1;
var b=this._listeners;return void 0!==b[c]&&-1!==b[c].indexOf(d)?!0:!1},removeEventListener:function(c,d){if(void 0!==this._listeners){var b=this._listeners[c];if(void 0!==b){var a=b.indexOf(d);-1!==a&&b.splice(a,1)}}},dispatchEvent:function(c){if(void 0!==this._listeners){var d=this._listeners[c.type];if(void 0!==d){c.target=this;for(var b=[],a=d.length,e=0;e<a;e++)b[e]=d[e];for(e=0;e<a;e++)b[e].call(this,c)}}}};var a={GOOGLEMAPSAPI:"http://maps.google.com/maps/api/js?sensor=false",GoogleStreetViewService:null,
GoogleGeoCoder:null,Utils:{loadAsync:function(c,d){var b=document.createElement("script");b.type="text/javascript";b.src=c;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(b,a);b.addEventListener("load",d)},getGoogleStreetViewService:function(){if(a.GoogleStreetViewService)return a.GoogleStreetViewService;a.GoogleStreetViewService=new google.maps.StreetViewService;return a.GoogleStreetViewService},getGoogleGeoCoder:function(){if(a.GoogleGeoCoder)return a.GoogleGeoCoder;a.GoogleGeoCoder=
new google.maps.Geocoder;return a.GoogleGeoCoder},resolveAddress:function(c,a){this.getGoogleGeoCoder().geocode({address:c},function(c,f){f==google.maps.GeocoderStatus.OK&&a(c[0].geometry.location)})}},Stitcher:function(c){this.canvas=c;this.ctx=this.canvas.getContext("2d");this.queue=[];this.loaded=this.toLoad=0}};a.Stitcher.prototype.reset=function(){this.loaded=this.toLoad=0};a.Stitcher.prototype.addTileTask=function(c){this.queue.push(c);this.toLoad++};a.Stitcher.prototype.updateProgress=function(){this.dispatchEvent({type:"progress",
message:100*this.loaded/this.toLoad})};a.Stitcher.prototype.processQueue=function(){this.updateProgress();if(0===this.queue.length)this.dispatchEvent({type:"finished"});else{var c=this.queue.shift(),a=new Image;a.addEventListener("load",function(){this.loaded++;this.ctx.drawImage(a,c.x,c.y);this.processQueue();a=null}.bind(this));a.addEventListener("error",function(){this.dispatchEvent({type:"error",message:"images missing"});this.processQueue();a=null}.bind(this));a.crossOrigin="";a.src=c.url}};
g.prototype.apply(a.Stitcher.prototype);a.Loader=function(){this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.stitcher=new a.Stitcher(this.canvas);this.stitcher.addEventListener("finished",function(){this.dispatchEvent({type:"load",message:"Panorama loaded"})}.bind(this));this.stitcher.addEventListener("progress",function(c){this.dispatchEvent({type:"progress",message:c.message})}.bind(this))};a.Loader.prototype.load=function(){};a.Loader.prototype.error=function(c){this.dispatchEvent({type:"error",
message:c})};g.prototype.apply(a.Loader.prototype);a.GoogleStreetViewLoader=function(){a.Loader.call(this);this.service=a.Utils.getGoogleStreetViewService();this.levelsW=[1,2,4,7,13,26];this.levelsH=[1,1,2,4,7,13];this.tileSize=416;this.widths=[416,832,1664,3328,6656,13312];this.heights=[416,416,832,1664,3328,6656];this.zoom=1;this.metadata={}};a.GoogleStreetViewLoader.prototype=Object.create(a.Loader.prototype);a.GoogleStreetViewLoader.prototype.load=function(c,a){void 0===a&&(console.warn("No zoom provided, assuming 1"),
a=1);this.zoom=a;this.canvas.width=this.widths[a];this.canvas.height=this.heights[a];var b=this.levelsW[a],f=this.levelsH[a],e=new XMLHttpRequest;e.open("GET","http://maps.google.com/cbk?output=json&cb_client=maps_sv&v=4&dm=1&pm=1&ph=1&hl=en&panoid="+c,!0);e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(this.metadata=JSON.parse(e.responseText))}.bind(this);e.send(null);this.service.getPanoramaById(c,function(a,c){null===a?this.error("Can't load panorama information"):this.dispatchEvent({type:"data",
message:a})}.bind(this));for(var g=0;g<f;g++)for(var h=0;h<b;h++){var k="https://geo0.ggpht.com/cbk?cb_client=maps_sv.tactile&authuser=0&hl=en&panoid="+c+"&output=tile&x="+h+"&y="+g+"&zoom="+a+"&nbt&fover=2";this.stitcher.addTileTask({url:k,x:512*h,y:512*g})}this.stitcher.processQueue()};a.GoogleStreetViewLoader.prototype.loadFromLocation=function(a,d){this.getIdByLocation(a,function(a){this.load(a,d)}.bind(this))};a.GoogleStreetViewLoader.prototype.loadFromURL=function(a,d){if(-1!=a.indexOf("panoid")){var b;
a:{b=a.split("&");for(var f=0;f<b.length;f++){var e=b[f].split("=");if("panoid"==decodeURIComponent(e[0])){b=decodeURIComponent(e[1]);break a}}b=void 0}this.load(b,2)}else-1!=a.indexOf("!1s")?(b=a.indexOf("!1s")+3,f=a.substr(b).indexOf("!"),b=a.substr(b,f),this.load(b,d)):this.dispatchEvent({type:"error",message:"can't find panorama id in specified URL"})};a.GoogleStreetViewLoader.prototype.getIdByLocation=function(a,d){var b="https://cbks0.google.com/cbk?cb_client=maps_sv.tactile&authuser=0&hl=en&output=polygon&it=1%3A1&rank=closest&ll="+
a.lat()+","+a.lng()+"&radius=50",f=new XMLHttpRequest;f.open("GET",b,!0);f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var a=JSON.parse(f.responseText);a&&a.result&&0!==a.result.length?d(a.result[0].id):this.error("No panoramas around location")}}.bind(this);f.send(null)};a.GooglePhotoSphereLoader=function(){a.Loader.call(this);this.service=a.Utils.getGoogleStreetViewService()};a.GooglePhotoSphereLoader.prototype=Object.create(a.Loader.prototype);a.GooglePhotoSphereLoader.prototype.loadFromURL=
function(a,d){if(-1!=a.indexOf("!1s")){var b=a.indexOf("!1s")+3,f=a.substr(b).indexOf("!"),b=a.substr(b,f);this.load(b,d)}};a.GooglePhotoSphereLoader.prototype.load=function(a,d){this.zoom=d;this.service.getPanoramaById(a,function(b,f){if(null===b)this.error("Can't load panorama information");else{var e=Math.floor(Math.log(b.tiles.worldSize.width/b.tiles.tileSize.width)/Math.log(2));this.canvas.width=b.tiles.worldSize.width*Math.pow(2,d-1)/Math.pow(2,e);this.canvas.height=b.tiles.worldSize.height*
Math.pow(2,d-1)/Math.pow(2,e);for(var e=this.canvas.width/b.tiles.tileSize.width,g=this.canvas.height/b.tiles.tileSize.height,h=0;h<g;h++)for(var k=0;k<e;k++)this.stitcher.addTileTask({url:"https://geo1.ggpht.com/cbk?cb_client=maps_sv.tactile&authuser=0&hl=en&panoid="+a+"&output=tile&x="+k+"&y="+h+"&zoom="+d+"&nbt&fover=2",x:k*b.tiles.tileSize.width,y:h*b.tiles.tileSize.height});this.stitcher.processQueue()}}.bind(this))};window.PANOMNOM=a})();
